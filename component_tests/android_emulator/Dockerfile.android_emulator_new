# ----------------------------------
# Stage 1: Build tools, SDKs, and AVD
# ----------------------------------
FROM ubuntu:24.04 AS builder

ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/emulator:${PATH}"

RUN apt-get update && apt-get install -y \
  curl unzip openjdk-17-jdk adb qemu-kvm \
  libgl1 libpulse0 libqt5widgets5 libnss3 \
  libxcomposite1 libxcursor1 libxdamage1 \
  libxi6 libxtst6 libxrandr2 libxss1 libasound2t64 \
  nodejs npm && \
  rm -rf /var/lib/apt/lists/*

# Install Appium and drivers
RUN npm install -g appium && appium driver install uiautomator2

# Install SDK tools
RUN mkdir -p "$ANDROID_SDK_ROOT/cmdline-tools" && \
  curl -sSL https://dl.google.com/android/repository/commandlinetools-linux-11076708_latest.zip -o cmd.zip && \
  unzip cmd.zip -d "$ANDROID_SDK_ROOT/cmdline-tools/tmp" && \
  mv "$ANDROID_SDK_ROOT/cmdline-tools/tmp/cmdline-tools" "$ANDROID_SDK_ROOT/cmdline-tools/latest" && \
  rm -rf cmd.zip "$ANDROID_SDK_ROOT/cmdline-tools/tmp"

RUN yes | sdkmanager --licenses && \
  sdkmanager --verbose \
    "platform-tools" \
    "emulator" \
    "platforms;android-33" \
    "system-images;android-33;google_apis;x86_64"

# Create AVD
RUN echo "no" | avdmanager create avd -n ci_emulator -k "system-images;android-33;google_apis;x86_64" --device "pixel"

# Install matching Chromedriver
RUN mkdir -p /opt/chromedrivers && \
    curl -sSL https://chromedriver.storage.googleapis.com/109.0.5414.74/chromedriver_linux64.zip -o /tmp/chromedriver.zip && \
    unzip /tmp/chromedriver.zip -d /opt/chromedrivers/ && \
    rm /tmp/chromedriver.zip && \
    chmod +x /opt/chromedrivers/chromedriver

# ----------------------------------
# Stage 2: Final lighter weight image
# ----------------------------------
FROM ubuntu:24.04

ENV ANDROID_SDK_ROOT=/opt/android-sdk
ENV JAVA_HOME=/usr/lib/jvm/java-17-openjdk-amd64
ENV PATH="${ANDROID_SDK_ROOT}/cmdline-tools/latest/bin:${ANDROID_SDK_ROOT}/platform-tools:${ANDROID_SDK_ROOT}/emulator:${PATH}"

# Only install runtime deps
RUN apt-get update && apt-get install -y \
  openjdk-17-jre-headless curl qemu-kvm \
  libgl1 libpulse0 libqt5widgets5 libnss3 \
  libxcomposite1 libxcursor1 libxdamage1 \
  libxi6 libxtst6 libxrandr2 libxss1 libasound2t64 \
  nodejs npm unzip && \
  rm -rf /var/lib/apt/lists/*

# Copy required parts from builder
COPY --from=builder /opt/android-sdk /opt/android-sdk
COPY --from=builder /root/.android /root/.android
COPY --from=builder /opt/chromedrivers /opt/chromedrivers
COPY --from=builder /usr/local/lib/node_modules /usr/local/lib/node_modules
COPY --from=builder /usr/local/bin/ /usr/local/bin/
COPY --from=builder /root/.appium /root/.appium

# Copy project files and entrypoint
WORKDIR /app
COPY . /app/component_tests/android_emulator
RUN chmod +x /app/component_tests/android_emulator/entrypoint.sh
RUN chmod +x /app/component_tests/android_emulator/wait-for-emulator.sh

EXPOSE 4723
ENTRYPOINT ["./component_tests/android_emulator/entrypoint.sh"]
